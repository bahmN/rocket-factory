name: Run Integration Tests

on:
  workflow_call:
    inputs:
      modules:
        required: true
        type: string
      go-version:
        required: true
        type: string

jobs:
  integration-test:
    name: Run integration tests
    runs-on: ubuntu-latest
    timeout-minutes: 30  # —á—Ç–æ–±—ã —Ö–≤–∞—Ç–∏–ª–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–±–æ—Ä–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4.2.2

      - name: üõ† Set up Go
        uses: actions/setup-go@v5.4.0
        with:
          go-version: ${{ inputs.go-version }}
          cache: false

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üß© Set up Docker cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: üìå Install Task
        uses: arduino/setup-task@v2.0.0

      - name: üßπ Cleanup old containers and networks
        run: |
          echo "üßπ Cleaning up dangling containers and networks..."
          docker container prune -f || true
          docker network prune -f || true

      - name: üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–æ–≤
        env:
          SERVICES: "inventory,order,payment"
        run: |
          echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
          task env:generate
          echo "‚úÖ –§–∞–π–ª—ã .env –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–æ–∑–¥–∞–Ω—ã"

      - name: üß™ Run integration tests via Taskfile
        env:
          MODULES: ${{ inputs.modules }}
        run: |
          # —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ CI
          export TESTCONTAINERS_STARTUP_TIMEOUT=120
          task test-integration
